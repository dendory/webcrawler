<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Crawler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .progress-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .crawl-status {
            font-size: 0.9em;
        }
        .status-crawling { color: #0d6efd; }
        .status-crawled { color: #198754; }
        .status-error { color: #dc3545; }
        .status-skipped { color: #6c757d; }
        
        /* Modal improvements */
        .modal {
            overflow: hidden;
        }
        .modal-dialog {
            margin: 1rem auto;
        }
        .modal-content {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .modal-body {
            padding: 1rem;
        }
        .list-group-item {
            border-left: none;
            border-right: none;
        }
        .list-group-item:first-child {
            border-top: none;
        }
        .list-group-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="fas fa-spider"></i> Web Crawler</h3>
                    </div>
                    <div class="card-body">
                        <form id="crawlForm">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="url" class="form-label">URL to Crawl</label>
                                    <input type="url" class="form-control" id="url" name="url" 
                                           placeholder="https://example.com" required>
                                </div>
                                <div class="col-md-2">
                                    <label for="mode" class="form-label">Crawl Mode</label>
                                    <select class="form-select" id="mode" name="mode">
                                        <option value="simple">Simple (for basic HTML sites)</option>
                                        <option value="wiki">Wiki (for MediaWiki style sites)</option>
                                        <option value="advanced">Advanced (uses Chromium to parse advanced JS sites)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="max_size" class="form-label">Max Size (Bytes)</label>
									<input type="number" class="form-control" id="max_size" name="max_size"
                                            value="10000000" required>
                                </div>
								<div class="col-md-3">
								  <label class="form-label d-block">Options</label>
								  <div class="form-check form-check-inline">
								    <input class="form-check-input" type="checkbox" id="niceness" name="niceness">
								    <label class="form-check-label" for="niceness">
								      <i class="fas fa-heart"></i> Be Nice (0.5s delay)
								    </label>
								  </div>
								  <div class="form-check form-check-inline">
								    <input class="form-check-input" type="checkbox" id="restrictpage" name="restrictpage" checked>
								    <label class="form-check-label" for="restrictpage">
								      <i class="fas fa-file-code"></i> Limit crawl to page
								    </label>
								  </div>
								</div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success w-100" id="submitBtn">
                                        <i class="fas fa-play"></i> Start
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Progress Section -->
                        <div id="progressSection" class="d-none">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Crawl Progress</h5>
                                    <button class="btn btn-danger btn-sm" onclick="abortCrawl()" id="abortBtn">
                                        <i class="fas fa-stop"></i> Abort Crawl
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-3">
                                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                                    </div>
                                    <div class="progress-container" id="progressList">
                                        <!-- Progress items will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Archives Table -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-archive"></i> Crawled Archives</h4>
                        <button class="btn btn-outline-secondary btn-sm" onclick="showIgnorePatternsModal()">
                            <i class="fas fa-filter"></i> Manage Ignore Patterns
                        </button>
                    </div>
                    <div class="card-body">
                        {% if archives %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>URL</th>
                                        <th>Mode</th>
                                        <th>Pages</th>
                                        <th>Created</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for archive in archives %}
                                    <tr>
                                        <td>{{ archive[0] }}</td>
                                        <td>
                                            <a href="{{ archive[1] }}" target="_blank" class="text-decoration-none">
                                                {{ archive[1][:50] }}{% if archive[1]|length > 50 %}...{% endif %}
                                            </a>
                                        </td>
                                        <td>
											<span class="badge 
											    {% if archive[2] == 'simple' %}
											        bg-primary
											    {% elif archive[2] == 'manual' %}
											        bg-danger
											    {% elif archive[2] == 'wiki' %}
											        bg-warning
											    {% elif archive[2] == 'advanced' %}
											        bg-success
											    {% else %}
											        bg-secondary
											    {% endif %}
											">
											    {{ archive[2].capitalize() }}
											</span>
                                        </td>
                                        <td>{{ archive[6] }}</td>
                                        <td>{{ archive[3] }}</td>
                                        <td>
                                            {% if archive[7] == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif archive[7].startswith('error') %}
                                                <span class="badge bg-danger">Error</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ archive[7] }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-info" onclick="viewArchiveDetails({{ archive[0] }})">
                                                    <i class="fas fa-info-circle"></i> Job details
                                                </button> &nbsp;
                                                <button class="btn btn-outline-primary" onclick="viewArchive({{ archive[0] }})">
                                                    <i class="fas fa-eye"></i> View archive
                                                </button> &nbsp;
                                                <button class="btn btn-outline-success" onclick="uploadToIA({{ archive[0] }})">
                                                    <i class="fas fa-upload"></i> Upload to IA
                                                </button> &nbsp;
                                                <button class="btn btn-outline-danger" onclick="deleteEntry({{ archive[0] }})">
                                                    <i class="fas fa-close"></i> Delete archive
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-archive fa-3x mb-3"></i>
                            <p>No crawled archives yet. Start a crawl to see results here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let progressInterval;
        let currentCrawlUrl = '';
        let currentCrawlThread = null;
        let isCrawlAborted = false;
        
        
        document.getElementById('crawlForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('url').value;
            const mode = document.getElementById('mode').value;
            const max_size = document.getElementById('max_size').value;
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            currentCrawlUrl = url;
            startCrawl(url, mode, max_size);
        });
        
        function startCrawl(url, mode, max_size) {
            // Get options
            const niceness = document.getElementById('niceness').checked;
            const restrictpage = document.getElementById('restrictpage').checked;
            
            // Reset abort state
            isCrawlAborted = false;
            
            // Disable form
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Crawling...';
            
            // Show progress section and reset progress display
            document.getElementById('progressSection').classList.remove('d-none');
            document.getElementById('progressList').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '';
            
            // Start progress polling
            progressInterval = setInterval(updateProgress, 1000);
            
            // Send crawl request
            fetch('/start_crawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}&mode=${encodeURIComponent(mode)}&niceness=${niceness}&restrictpage=${restrictpage}&max_size=${encodeURIComponent(max_size)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    resetForm();
                } else {
                    // Store the crawl URL for tracking
                    currentCrawlUrl = url;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting crawl');
                resetForm();
            });
        }
        
        function abortCrawl() {
            if (!currentCrawlUrl) {
                alert('No active crawl to abort');
                return;
            }
            
            const confirmed = confirm('Are you sure you want to abort the current crawl? This action cannot be undone.');
            if (!confirmed) {
                return;
            }
            
            // Set abort flag
            isCrawlAborted = true;
            
            // Disable abort button
            document.getElementById('abortBtn').disabled = true;
            document.getElementById('abortBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aborting...';
            
            // Send abort request
            fetch('/abort_crawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(currentCrawlUrl)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error aborting crawl: ' + data.error);
                } else {
                    // Immediately reset form when abort is successful
                    resetForm();
                }
            })
            .catch(error => {
                console.error('Error aborting crawl:', error);
                alert('Error aborting crawl');
                resetForm();
            });
        }
        
        function updateProgress() {
            fetch('/progress')
            .then(response => response.json())
            .then(data => {
                const progressList = document.getElementById('progressList');
                const progressBar = document.getElementById('progressBar');
                
                const individual = data.individual || {};
                const stats = data.stats || {};
                
                let totalUrls = Object.keys(individual).length;
                let completedUrls = 0;
                
                // Add progress items in reverse order (newest first)
                const sortedEntries = Object.entries(individual).sort((a, b) => {
                    // Sort by timestamp, newest first
                    const timeA = new Date(a[1].timestamp || 0);
                    const timeB = new Date(b[1].timestamp || 0);
                    return timeB - timeA;
                })
                .slice(0, 1000); // only take the latest 1000 entries

                // Clear previous progress
                progressList.innerHTML = '';

                for (const [url, status] of sortedEntries) {
                    if (status.status === 'crawled' || status.status === 'error' || status.status === 'skipped') {
                        completedUrls++;
                    }
                    
                    const statusClass = `status-${status.status}`;
                    const statusIcon = status.status === 'crawling' ? 'fa-spinner fa-spin' :
                                     status.status === 'crawled' ? 'fa-check' :
                                     status.status === 'error' ? 'fa-times' :
                                     status.status === 'skipped' ? 'fa-ban' : 'fa-clock';
                    
                    const progressItem = document.createElement('div');
                    progressItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                    progressItem.innerHTML = `
                        <div class="crawl-status">
                            <i class="fas ${statusIcon} ${statusClass} me-2"></i>
                            <span class="text-truncate" style="max-width: 400px;">${url}</span>
                        </div>
                        <div class="text-muted small">
                            ${status.status_code ? `HTTP ${status.status_code}` : ''}
                            ${status.error ? ` - ${status.error}` : ''}
                            ${status.message ? ` - ${status.message}` : ''}
                        </div>
                    `;
                    progressList.appendChild(progressItem);
                }
                
                // Update progress bar with overall stats
                const currentCrawlStats = stats[currentCrawlUrl];
                if (currentCrawlStats) {
                    const totalDiscovered = currentCrawlStats.total_discovered || totalUrls;
                    const totalCompleted = currentCrawlStats.total_completed || completedUrls;
                    
                    if (totalDiscovered > 0) {
                        const progressPercent = (totalCompleted / totalDiscovered) * 100;
                        progressBar.style.width = progressPercent + '%';
                        progressBar.textContent = `${totalCompleted}/${totalDiscovered} pages`;
                    }
                    
                    // Check if crawl is complete or aborted
                    if (currentCrawlStats.status === 'completed' || currentCrawlStats.status === 'aborted' || (totalDiscovered > 0 && totalCompleted >= totalDiscovered)) {
                        setTimeout(() => {
                            clearInterval(progressInterval);
                            resetForm();
                            // Reload page to show new archive (unless aborted)
                            if (currentCrawlStats.status !== 'aborted') {
                                window.location.reload();
                            }
                        }, 2000);
                    }
                } else if (totalUrls > 0) {
                    // Fallback to old method if stats not available
                    const progressPercent = (completedUrls / totalUrls) * 100;
                    progressBar.style.width = progressPercent + '%';
                    progressBar.textContent = `${completedUrls}/${totalUrls} pages`;
                    
                    if (completedUrls === totalUrls) {
                        setTimeout(() => {
                            clearInterval(progressInterval);
                            resetForm();
                            window.location.reload();
                        }, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
            });
        }
        
        function resetForm() {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-play"></i> Start';
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            // Hide progress section and clear progress list
            document.getElementById('progressSection').classList.add('d-none');
            document.getElementById('progressList').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '';
            
            // Reset abort state
            isCrawlAborted = false;
            currentCrawlUrl = '';
            
            // Reset abort button
            const abortBtn = document.getElementById('abortBtn');
            if (abortBtn) {
                abortBtn.disabled = false;
                abortBtn.innerHTML = '<i class="fas fa-stop"></i> Abort Crawl';
            }
        }
        
        function viewArchiveDetails(archiveId) {
            // Show log modal instead of JSON details
            showLogModal(archiveId);
        }
        
        function showLogModal(archiveId) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" style="max-width: 90vw; height: 90vh;">
                        <div class="modal-content h-100 d-flex flex-column">
                            <div class="modal-header flex-shrink-0">
                                <h5 class="modal-title" id="logModalLabel">
                                    <i class="fas fa-file-alt"></i> Crawl Log Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body flex-grow-1 d-flex flex-column" style="overflow: hidden;">
                                <div id="logLoading" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading log file...</p>
                                </div>
                                <div id="logContent" class="d-none flex-grow-1" style="overflow-y: auto; min-height: 0;">
                                    <pre id="logText" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; margin: 0;"></pre>
                                </div>
                                <div id="logError" class="d-none">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <strong>Error loading log file!</strong>
                                        <div id="logErrorMessage"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer flex-shrink-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="downloadLog(${archiveId})">
                                    <i class="fas fa-download"></i> Download Log
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('logModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('logModal'));
            modal.show();

            // Load log content
            loadLogContent(archiveId);
        }
        
        function loadLogContent(archiveId) {
            fetch(`/log_file/${archiveId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showLogError(data.error);
                        return;
                    }
                    
                    // Show log content
                    document.getElementById('logLoading').classList.add('d-none');
                    document.getElementById('logContent').classList.remove('d-none');
                    document.getElementById('logText').textContent = data.log_content;
                })
                .catch(error => {
                    console.error('Error loading log content:', error);
                    showLogError('Failed to load log file: ' + error.message);
                });
        }
        
        function showLogError(message) {
            document.getElementById('logLoading').classList.add('d-none');
            document.getElementById('logError').classList.remove('d-none');
            document.getElementById('logErrorMessage').textContent = message;
        }
        
        function downloadLog(archiveId) {
            fetch(`/log_file/${archiveId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    // Create download link
                    const blob = new Blob([data.log_content], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `crawl_log_${archiveId}.log`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error downloading log:', error);
                    alert('Error downloading log file');
                });
        }
        
        function viewArchive(archiveId) {
            window.open(`/view_archive/${archiveId}`, '_new');
        }

        function deleteEntry(archiveId) {
		    const confirmed = confirm("Are you sure you want to delete this entry?");
		    if (confirmed) {
		        showDeleteModal(archiveId);
			}
        }

		function showDeleteModal(archiveId) {
		    // Create modal HTML
		    const modalHtml = `
		        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
		            <div class="modal-dialog">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title" id="deleteModalLabel">
		                            <i class="fas fa-trash"></i> Deleting Archive
		                        </h5>
		                    </div>
		                    <div class="modal-body">
		                        <div id="deleteProgress">
		                            <div class="d-flex align-items-center mb-3">
		                                <div class="spinner-border spinner-border-sm text-danger me-3" role="status">
		                                    <span class="visually-hidden">Loading...</span>
		                                </div>
		                                <span id="deleteStatus">Starting deletion...</span>
		                            </div>
		                            <div class="progress">
		                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
		                                     role="progressbar" style="width: 0%" id="deleteProgressBar"></div>
		                            </div>
		                            <div class="mt-2">
		                                <small class="text-muted" id="deleteDetails">Preparing deletion...</small>
		                            </div>
		                        </div>
		                        <div id="deleteResult" class="d-none">
		                            <div id="deleteSuccess" class="d-none">
		                                <div class="alert alert-success">
		                                    <i class="fas fa-check-circle"></i>
		                                    <strong>Deletion Successful!</strong>
		                                    <div id="deleteSuccessMessage"></div>
		                                </div>
		                            </div>
		                            <div id="deleteError" class="d-none">
		                                <div class="alert alert-danger">
		                                    <i class="fas fa-exclamation-circle"></i>
		                                    <strong>Deletion Failed!</strong>
		                                    <div id="deleteErrorMessage"></div>
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeDeleteModalBtn">Close</button>
		                    </div>
		                </div>
		            </div>
		        </div>
		    `;

		    // Remove existing modal if any
		    const existingModal = document.getElementById('deleteModal');
		    if (existingModal) {
		        existingModal.remove();
		    }

		    // Add modal to page
		    document.body.insertAdjacentHTML('beforeend', modalHtml);

		    // Show modal
		    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
		    modal.show();

		    // Start deletion process
		    startDelete(archiveId);
		}

		function startDelete(archiveId) {
		    // Send delete request
		    fetch(`/delete/${archiveId}`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        }
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.error) {
		            showDeleteError(data.error);
		            return;
		        }
		        
		        // Start polling for status
		        pollDeleteStatus(archiveId);
		    })
		    .catch(error => {
		        console.error('Error starting deletion:', error);
		        showDeleteError('Failed to start deletion: ' + error.message);
		    });
		}

		function pollDeleteStatus(archiveId) {
		    const maxAttempts = 10; // 20 seconds max (2 second intervals)
		    let attempts = 0;

		    const pollInterval = setInterval(() => {
		        attempts++;
		        
		        fetch(`/delete_status/${archiveId}`)
		            .then(response => response.json())
		            .then(data => {
		                updateDeleteProgress(data);
		                
		                // Check if deletion is complete
		                if (data.status === 'success' || data.status === 'error') {
		                    clearInterval(pollInterval);
		                    
		                    if (data.status === 'success') {
		                        showDeleteSuccess(data);
		                    } else {
		                        showDeleteError(data.message);
		                    }
		                }
		            })
		            .catch(error => {
		                console.error('Error polling delete status:', error);
		                if (attempts >= maxAttempts) {
		                    clearInterval(pollInterval);
		                    showDeleteError('Delete status check failed');
		                }
		            });

		        // Stop polling after max attempts
		        if (attempts >= maxAttempts) {
		            clearInterval(pollInterval);
		            showDeleteError('Delete timeout - please check the logs');
		        }
		    }, 2000); // Poll every 2 seconds
		}

		function updateDeleteProgress(data) {
		    const statusElement = document.getElementById('deleteStatus');
		    const detailsElement = document.getElementById('deleteDetails');
		    const progressBar = document.getElementById('deleteProgressBar');

		    if (statusElement) statusElement.textContent = data.message || 'Processing...';
		    if (detailsElement) detailsElement.textContent = `Status: ${data.status} | Time: ${data.timestamp || 'Unknown'}`;

		    // Update progress bar based on status
		    let progress = 0;
		    switch (data.status) {
		        case 'starting':
		            progress = 10;
		            break;
		        case 'deleting':
		            progress = 50;
		            break;
		        case 'success':
		            progress = 100;
		            break;
		        case 'error':
		            progress = 100;
		            break;
		        default:
		            progress = 25;
		    }

		    if (progressBar) {
		        progressBar.style.width = progress + '%';
		        if (data.status === 'success') {
		            progressBar.classList.remove('progress-bar-animated');
		            progressBar.classList.add('bg-success');
		        } else if (data.status === 'error') {
		            progressBar.classList.remove('progress-bar-animated');
		            progressBar.classList.add('bg-danger');
		        }
		    }
		}

		function showDeleteSuccess(data) {
		    document.getElementById('deleteProgress').classList.add('d-none');
		    document.getElementById('deleteResult').classList.remove('d-none');
		    document.getElementById('deleteSuccess').classList.remove('d-none');
		    
		    document.getElementById('deleteSuccessMessage').textContent = data.message;
		    
		    // Auto-reload page after 2 seconds to show updated list
		    setTimeout(() => {
		        window.location.reload();
		    }, 2000);
		}

		function showDeleteError(message) {
		    document.getElementById('deleteProgress').classList.add('d-none');
		    document.getElementById('deleteResult').classList.remove('d-none');
		    document.getElementById('deleteError').classList.remove('d-none');
		    
		    document.getElementById('deleteErrorMessage').textContent = message;
        }

		function uploadToIA(archiveId) {
		    const title = prompt("Enter a title:");
		    if (title === null) return; // User canceled

		    const description = prompt("Enter a description:");
		    if (description === null) return; // User canceled

		    // Show upload modal
		    showUploadModal(archiveId, title, description);
		}

		function showUploadModal(archiveId, title, description) {
		    // Create modal HTML
		    const modalHtml = `
		        <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
		            <div class="modal-dialog">
		                <div class="modal-content">
		                    <div class="modal-header">
		                        <h5 class="modal-title" id="uploadModalLabel">
		                            <i class="fas fa-upload"></i> Uploading to Internet Archive
		                        </h5>
		                    </div>
		                    <div class="modal-body">
		                        <div id="uploadProgress">
		                            <div class="d-flex align-items-center mb-3">
		                                <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
		                                    <span class="visually-hidden">Loading...</span>
		                                </div>
		                                <span id="uploadStatus">Starting upload...</span>
		                            </div>
		                            <div class="progress">
		                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
		                                     role="progressbar" style="width: 0%" id="uploadProgressBar"></div>
		                            </div>
		                            <div class="mt-2">
		                                <small class="text-muted" id="uploadDetails">Preparing upload...</small>
		                            </div>
		                        </div>
		                        <div id="uploadResult" class="d-none">
		                            <div id="uploadSuccess" class="d-none">
		                                <div class="alert alert-success">
		                                    <i class="fas fa-check-circle"></i>
		                                    <strong>Upload Successful!</strong>
		                                    <div id="successMessage"></div>
		                                </div>
		                            </div>
		                            <div id="uploadError" class="d-none">
		                                <div class="alert alert-danger">
		                                    <i class="fas fa-exclamation-circle"></i>
		                                    <strong>Upload Failed!</strong>
		                                    <div id="errorMessage"></div>
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="modal-footer">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalBtn">Close</button>
		                    </div>
		                </div>
		            </div>
		        </div>
		    `;

		    // Remove existing modal if any
		    const existingModal = document.getElementById('uploadModal');
		    if (existingModal) {
		        existingModal.remove();
		    }

		    // Add modal to page
		    document.body.insertAdjacentHTML('beforeend', modalHtml);

		    // Show modal
		    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
		    modal.show();

		    // Start upload process
		    startUpload(archiveId, title, description);
		}

		function startUpload(archiveId, title, description) {
		    // Send upload request
		    fetch(`/ia/${archiveId}`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify({
		            title: title,
		            description: description
		        })
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.error) {
		            showUploadError(data.error);
		            return;
		        }
		        
		        // Start polling for status
		        pollUploadStatus(archiveId);
		    })
		    .catch(error => {
		        console.error('Error starting upload:', error);
		        showUploadError('Failed to start upload: ' + error.message);
		    });
		}

		function pollUploadStatus(archiveId) {
		    const maxAttempts = 60; // 5 minutes max (5 second intervals)
		    let attempts = 0;

		    const pollInterval = setInterval(() => {
		        attempts++;
		        
		        fetch(`/ia_status/${archiveId}`)
		            .then(response => response.json())
		            .then(data => {
		                updateUploadProgress(data);
		                
		                // Check if upload is complete
		                if (data.status === 'success' || data.status === 'error') {
		                    clearInterval(pollInterval);
		                    
		                    if (data.status === 'success') {
		                        showUploadSuccess(data);
		                    } else {
		                        showUploadError(data.message);
		                    }
		                }
		            })
		            .catch(error => {
		                console.error('Error polling upload status:', error);
		                if (attempts >= maxAttempts) {
		                    clearInterval(pollInterval);
		                    showUploadError('Upload status check failed');
		                }
		            });

		        // Stop polling after max attempts
		        if (attempts >= maxAttempts) {
		            clearInterval(pollInterval);
		            showUploadError('Upload timeout - please check the logs');
		        }
		    }, 5000); // Poll every 5 seconds
		}

		function updateUploadProgress(data) {
		    const statusElement = document.getElementById('uploadStatus');
		    const detailsElement = document.getElementById('uploadDetails');
		    const progressBar = document.getElementById('uploadProgressBar');

		    if (statusElement) statusElement.textContent = data.message || 'Processing...';
		    if (detailsElement) detailsElement.textContent = `Status: ${data.status} | Time: ${data.timestamp || 'Unknown'}`;

		    // Update progress bar based on status
		    let progress = 0;
		    switch (data.status) {
		        case 'starting':
		            progress = 10;
		            break;
		        case 'uploading':
		            progress = 50;
		            break;
		        case 'success':
		            progress = 100;
		            break;
		        case 'error':
		            progress = 100;
		            break;
		        default:
		            progress = 25;
		    }

		    if (progressBar) {
		        progressBar.style.width = progress + '%';
		        if (data.status === 'success') {
		            progressBar.classList.remove('progress-bar-animated');
		            progressBar.classList.add('bg-success');
		        } else if (data.status === 'error') {
		            progressBar.classList.remove('progress-bar-animated');
		            progressBar.classList.add('bg-danger');
		        }
		    }
		}

		function showUploadSuccess(data) {
		    document.getElementById('uploadProgress').classList.add('d-none');
		    document.getElementById('uploadResult').classList.remove('d-none');
		    document.getElementById('uploadSuccess').classList.remove('d-none');
		    
		    const successMessage = document.getElementById('successMessage');
		    if (data.identifier) {
		        successMessage.innerHTML = `
		            <div>${data.message}</div>
		            <div class="mt-2">
		                <a href="https://archive.org/details/${data.identifier}" target="_blank" class="btn btn-sm btn-outline-success">
		                    <i class="fas fa-external-link-alt"></i> View on Internet Archive
		                </a>
		            </div>
		        `;
		    } else {
		        successMessage.textContent = data.message;
		    }
		}

		function showUploadError(message) {
		    document.getElementById('uploadProgress').classList.add('d-none');
		    document.getElementById('uploadResult').classList.remove('d-none');
		    document.getElementById('uploadError').classList.remove('d-none');
		    
		    document.getElementById('errorMessage').textContent = message;
		}

		function showIgnorePatternsModal() {
		    // Create modal HTML
		    const modalHtml = `
		        <div class="modal fade" id="ignorePatternsModal" tabindex="-1" aria-labelledby="ignorePatternsModalLabel" aria-hidden="true">
		            <div class="modal-dialog modal-xl" style="max-width: 90vw; height: 90vh;">
		                <div class="modal-content h-100 d-flex flex-column">
		                    <div class="modal-header flex-shrink-0">
		                        <h5 class="modal-title" id="ignorePatternsModalLabel">
		                            <i class="fas fa-filter"></i> Manage Ignore Patterns
		                        </h5>
		                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		                    </div>
		                    <div class="modal-body flex-grow-1 d-flex flex-column" style="overflow: hidden;">
		                        <div class="mb-3 flex-shrink-0">
		                            <button class="btn btn-primary btn-sm" onclick="showAddPatternForm()">
		                                <i class="fas fa-plus"></i> Add New Pattern
		                            </button>
		                        </div>
		                        
		                        <div id="addPatternForm" class="d-none mb-4 p-3 border rounded bg-light flex-shrink-0">
		                            <h6>Add New Pattern</h6>
		                            <div class="mb-3">
		                                <label for="newPattern" class="form-label">Regex Pattern</label>
		                                <input type="text" class="form-control" id="newPattern" placeholder="^https?://example\\.com/.*">
		                                <div class="form-text">Use regex syntax. Example: ^https?://example\\.com/.*</div>
		                            </div>
		                            <div class="mb-3">
		                                <label for="newDescription" class="form-label">Description (optional)</label>
		                                <input type="text" class="form-control" id="newDescription" placeholder="Description of what this pattern matches">
		                            </div>
		                            <div class="mb-3">
		                                <div class="form-check">
		                                    <input class="form-check-input" type="checkbox" id="newEnabled" checked>
		                                    <label class="form-check-label" for="newEnabled">
		                                        Enabled
		                                    </label>
		                                </div>
		                            </div>
		                            <div>
		                                <button class="btn btn-success btn-sm" onclick="addPattern()">Add Pattern</button>
		                                <button class="btn btn-secondary btn-sm" onclick="hideAddPatternForm()">Cancel</button>
		                            </div>
		                        </div>
		                        
		                        <div id="patternsList" class="flex-grow-1" style="overflow-y: auto; min-height: 0;">
		                            <div class="text-center">
		                                <div class="spinner-border" role="status">
		                                    <span class="visually-hidden">Loading...</span>
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="modal-footer flex-shrink-0">
		                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		                    </div>
		                </div>
		            </div>
		        </div>
		    `;

		    // Remove existing modal if any
		    const existingModal = document.getElementById('ignorePatternsModal');
		    if (existingModal) {
		        existingModal.remove();
		    }

		    // Add modal to page
		    document.body.insertAdjacentHTML('beforeend', modalHtml);

		    // Show modal
		    const modal = new bootstrap.Modal(document.getElementById('ignorePatternsModal'));
		    modal.show();

		    // Load patterns
		    loadIgnorePatterns();
		}

		function loadIgnorePatterns() {
		    fetch('/ignore_patterns')
		        .then(response => response.json())
		        .then(data => {
		            displayIgnorePatterns(data.patterns);
		        })
		        .catch(error => {
		            console.error('Error loading patterns:', error);
		            document.getElementById('patternsList').innerHTML = '<div class="alert alert-danger">Error loading patterns</div>';
		        });
		}

		function displayIgnorePatterns(patterns) {
		    const patternsList = document.getElementById('patternsList');
		    
		    if (patterns.length === 0) {
		        patternsList.innerHTML = '<div class="text-muted">No ignore patterns configured.</div>';
		        return;
		    }

		    let html = '<div class="list-group">';
		    
		    patterns.forEach(pattern => {
		        const statusClass = pattern.enabled ? 'text-success' : 'text-muted';
		        const statusIcon = pattern.enabled ? 'fa-check-circle' : 'fa-times-circle';
		        
		        html += `
		            <div class="list-group-item">
		                <div class="d-flex justify-content-between align-items-start">
		                    <div class="flex-grow-1">
		                        <div class="d-flex align-items-center mb-2">
		                            <i class="fas ${statusIcon} ${statusClass} me-2"></i>
		                            <code class="bg-light p-1 rounded">${escapeHtml(pattern.pattern)}</code>
		                        </div>
		                        ${pattern.description ? `<div class="text-muted small">${escapeHtml(pattern.description)}</div>` : ''}
		                        <div class="text-muted small">Added: ${pattern.created_at}</div>
		                    </div>
		                    <div class="btn-group btn-group-sm">
		                        <button class="btn btn-outline-primary" onclick="togglePattern(${pattern.id}, ${pattern.enabled})">
		                            <i class="fas fa-${pattern.enabled ? 'pause' : 'play'}"></i>
		                        </button>
		                        <button class="btn btn-outline-danger" onclick="deletePattern(${pattern.id})">
		                            <i class="fas fa-trash"></i>
		                        </button>
		                    </div>
		                </div>
		            </div>
		        `;
		    });
		    
		    html += '</div>';
		    patternsList.innerHTML = html;
		}

		function showAddPatternForm() {
		    document.getElementById('addPatternForm').classList.remove('d-none');
		}

		function hideAddPatternForm() {
		    document.getElementById('addPatternForm').classList.add('d-none');
		    document.getElementById('newPattern').value = '';
		    document.getElementById('newDescription').value = '';
		    document.getElementById('newEnabled').checked = true;
		}

		function addPattern() {
		    const pattern = document.getElementById('newPattern').value.trim();
		    const description = document.getElementById('newDescription').value.trim();
		    const enabled = document.getElementById('newEnabled').checked;

		    if (!pattern) {
		        alert('Pattern is required');
		        return;
		    }

		    fetch('/ignore_patterns', {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify({
		            pattern: pattern,
		            description: description,
		            enabled: enabled
		        })
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.error) {
		            alert('Error: ' + data.error);
		        } else {
		            hideAddPatternForm();
		            loadIgnorePatterns();
		        }
		    })
		    .catch(error => {
		        console.error('Error adding pattern:', error);
		        alert('Error adding pattern');
		    });
		}

		function togglePattern(patternId, currentEnabled) {
		    fetch(`/ignore_patterns/${patternId}`, {
		        method: 'PUT',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify({
		            enabled: !currentEnabled
		        })
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.error) {
		            alert('Error: ' + data.error);
		        } else {
		            loadIgnorePatterns();
		        }
		    })
		    .catch(error => {
		        console.error('Error toggling pattern:', error);
		        alert('Error toggling pattern');
		    });
		}

		function deletePattern(patternId) {
		    if (!confirm('Are you sure you want to delete this pattern?')) {
		        return;
		    }

		    fetch(`/ignore_patterns/${patternId}`, {
		        method: 'DELETE',
		        headers: {
		        }
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.error) {
		            alert('Error: ' + data.error);
		        } else {
		            loadIgnorePatterns();
		        }
		    })
		    .catch(error => {
		        console.error('Error deleting pattern:', error);
		        alert('Error deleting pattern');
		    });
		}

		function escapeHtml(text) {
		    const div = document.createElement('div');
		    div.textContent = text;
		    return div.innerHTML;
		}

		// Functions to handle active crawl reconnection
		function checkForActiveCrawls() {
		    fetch('/active_crawls')
		        .then(response => response.json())
		        .then(data => {
		            if (data.has_active_crawls && data.active_crawls.length > 0) {
		                // Found active crawls - reconnect to the first one
		                const activeCrawl = data.active_crawls[0];
		                reconnectToCrawl(activeCrawl);
		            }
		        })
		        .catch(error => {
		            console.error('Error checking for active crawls:', error);
		        });
		}

		function reconnectToCrawl(crawlData) {
		    // Set the current crawl URL
		    currentCrawlUrl = crawlData.url;
		    
		    // Show progress section
		    document.getElementById('progressSection').classList.remove('d-none');
		    document.getElementById('progressList').innerHTML = '';
		    
		    // Disable form to prevent new crawls
		    document.getElementById('submitBtn').disabled = true;
		    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Crawling...';
		    
		    // Start progress polling
		    progressInterval = setInterval(updateProgress, 1000);
		    
		    // Show a notification that we reconnected
		    showReconnectNotification(crawlData.url);
		}

		function showReconnectNotification(url) {
		    // Create a notification banner
		    const notification = document.createElement('div');
		    notification.className = 'alert alert-info alert-dismissible fade show';
		    notification.innerHTML = `
		        <i class="fas fa-info-circle"></i>
		        Reconnected to active crawl: <strong>${escapeHtml(url)}</strong>
		        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		    `;
		    
		    // Insert at the top of the container
		    const container = document.querySelector('.container-fluid');
		    container.insertBefore(notification, container.firstChild);
		    
		    // Auto-dismiss after 5 seconds
		    setTimeout(() => {
		        if (notification.parentNode) {
		            notification.remove();
		        }
		    }, 5000);
		}

		// Check for active crawls when page loads
		document.addEventListener('DOMContentLoaded', function() {
		    checkForActiveCrawls();
		});
    </script>
</body>
</html>
